<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Wheel - Stage Lighting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #0a0a0f;
            font-family: 'Times New Roman', Times, serif;
            overflow: hidden;
        }

        /* Stage Area */
        #stage-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #stage {
            width: 100%;
            height: 100%;
        }

        /* Control Panel */
        #control-panel {
            background: linear-gradient(to bottom, #0a0a0a 0%, #000 50%, #0a0a0a 100%);
            border-top: 4px solid #222;
            padding: 25px 30px;
            display: flex;
            align-items: stretch;
            justify-content: center;
            gap: 25px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
            position: relative;
        }
        #control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.01) 2px,
                rgba(255,255,255,0.01) 4px
            );
            pointer-events: none;
        }

        /* Panel Screws */
        .panel-screw {
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #444 0%, #222 50%, #333 100%);
            border-radius: 50%;
            position: absolute;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5), 0 1px 1px rgba(255,255,255,0.1);
        }
        .panel-screw::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 1px;
            width: 6px;
            height: 2px;
            background: #1a1a1a;
            border-radius: 1px;
        }

        /* Control Panel Frame */
        .panel-section {
            background: linear-gradient(to bottom, #1a1a1a, #0f0f0f);
            border: 3px solid #333;
            border-radius: 8px;
            padding: 18px;
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.8),
                inset 0 -1px 2px rgba(255,255,255,0.05),
                0 4px 8px rgba(0,0,0,0.5);
            position: relative;
        }
        .panel-section::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 10px;
            background: linear-gradient(to bottom, #444, #222);
            z-index: -1;
        }
        .panel-label {
            color: #ff6600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255,102,0,0.5);
            font-weight: bold;
            padding: 4px 8px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 3px;
        }

        /* RGB Sliders - Fader Style */
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-width: 200px;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #0a0a0a;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #222;
        }
        .slider-label {
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 24px;
            border-radius: 4px;
            background: #1a1a1a;
            border: 2px solid;
        }
        .slider-label.red {
            color: #ff4444;
            border-color: #ff4444;
            box-shadow: 0 0 8px rgba(255,68,68,0.3);
        }
        .slider-label.green {
            color: #44ff44;
            border-color: #44ff44;
            box-shadow: 0 0 8px rgba(68,255,68,0.3);
        }
        .slider-label.blue {
            color: #4444ff;
            border-color: #6666ff;
            box-shadow: 0 0 8px rgba(68,68,255,0.3);
        }

        .color-slider {
            -webkit-appearance: none;
            appearance: none;
            flex: 1;
            height: 8px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            border: 2px solid #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .color-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 28px;
            border-radius: 3px;
            background: linear-gradient(to bottom, #666, #333, #444);
            border: 1px solid #555;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .color-slider::-webkit-slider-thumb:hover {
            background: linear-gradient(to bottom, #777, #444, #555);
        }
        .color-slider::-moz-range-thumb {
            width: 16px;
            height: 28px;
            border-radius: 3px;
            background: linear-gradient(to bottom, #666, #333, #444);
            border: 1px solid #555;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        #red-slider {
            background: linear-gradient(to right, #1a0000, #ff0000);
        }
        #green-slider {
            background: linear-gradient(to right, #001a00, #00ff00);
        }
        #blue-slider {
            background: linear-gradient(to right, #00001a, #0000ff);
        }
        .slider-value {
            width: 40px;
            font-size: 14px;
            color: #0f0;
            text-align: center;
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            padding: 4px 6px;
            border: 1px solid #333;
            border-radius: 3px;
            text-shadow: 0 0 8px rgba(0,255,0,0.5);
        }
        .color-preview-box {
            width: 100%;
            height: 35px;
            border-radius: 4px;
            border: 3px solid #333;
            margin-top: 8px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 0 15px currentColor;
        }

        /* Harmony Buttons - Physical Button Style */
        .harmony-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .harmony-btn {
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a, #0f0f0f);
            border: 2px solid #444;
            border-bottom-color: #222;
            color: #888;
            padding: 10px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.1s;
            box-shadow:
                0 3px 0 #111,
                0 4px 6px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
        }
        .harmony-btn::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #222;
        }
        .harmony-btn:hover {
            background: linear-gradient(to bottom, #333, #222, #1a1a1a);
            color: #aaa;
        }
        .harmony-btn:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 #111,
                0 2px 3px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .harmony-btn.active {
            background: linear-gradient(to bottom, #1a3a1a, #0f2a0f, #0a1a0a);
            border-color: #2a5a2a;
            color: #4f4;
            text-shadow: 0 0 8px rgba(68,255,68,0.5);
        }
        .harmony-btn.active::before {
            background: #4f4;
            box-shadow: 0 0 8px #4f4;
        }

        /* Color Preview - Monitor Style */
        .color-preview {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            border: 2px solid #333;
        }
        .preview-swatch {
            width: 35px;
            height: 35px;
            border-radius: 4px;
            border: 3px solid #222;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        #main-swatch {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 20px currentColor;
            border-color: #444;
        }
        .swatch-label {
            font-size: 8px;
            color: #666;
            text-align: center;
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* LED Indicator */
        .led-strip {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
            padding: 6px;
            background: #0a0a0a;
            border-radius: 3px;
            border: 1px solid #222;
        }
        .led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #222);
            border: 1px solid #111;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }
        .led.on {
            background: radial-gradient(circle at 30% 30%, #6f6, #0c0);
            box-shadow: 0 0 10px #0f0, 0 0 20px rgba(0,255,0,0.3);
        }
        .led.red { background: radial-gradient(circle at 30% 30%, #f66, #c00); box-shadow: 0 0 10px #f00; }
        .led.amber { background: radial-gradient(circle at 30% 30%, #fa6, #c60); box-shadow: 0 0 10px #f80; }

        /* Power indicator */
        .power-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 8px;
            color: #666;
            text-transform: uppercase;
        }
        .power-led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #6f6, #0c0);
            box-shadow: 0 0 8px #0f0;
        }

        /* Brand label */
        .brand-label {
            position: absolute;
            bottom: 8px;
            right: 15px;
            font-size: 10px;
            color: #444;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        /* Decorative buttons section */
        .deco-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .deco-btn {
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a, #0f0f0f);
            border: 2px solid #444;
            border-bottom-color: #222;
            color: #666;
            padding: 8px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow:
                0 3px 0 #111,
                0 4px 6px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .deco-btn:hover {
            background: linear-gradient(to bottom, #333, #222, #1a1a1a);
            color: #888;
        }
        .deco-btn:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 #111,
                0 2px 3px rgba(0,0,0,0.5);
        }
        .deco-btn.red-btn {
            border-color: #600;
            color: #a00;
        }
        .deco-btn.red-btn:hover {
            color: #c00;
        }
        .deco-btn.amber-btn {
            border-color: #640;
            color: #a60;
        }
        .deco-btn.amber-btn:hover {
            color: #c80;
        }

        /* Instruction Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: linear-gradient(to bottom, #1a1a1a, #0f0f0f);
            border: 3px solid #444;
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0,0,0,0.8), 0 0 100px rgba(255,102,0,0.1);
        }
        .modal-title {
            color: #ff6600;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255,102,0,0.5);
        }
        .modal-text {
            color: #ccc;
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 25px;
        }
        .modal-ok-btn {
            background: linear-gradient(to bottom, #2a4a2a, #1a3a1a, #0f2a0f);
            border: 2px solid #4a6a4a;
            color: #4f4;
            padding: 12px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow:
                0 4px 0 #0a1a0a,
                0 5px 10px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.1s;
        }
        .modal-ok-btn:hover {
            background: linear-gradient(to bottom, #3a5a3a, #2a4a2a, #1a3a1a);
            color: #6f6;
            text-shadow: 0 0 10px rgba(68,255,68,0.5);
        }
        .modal-ok-btn:active {
            transform: translateY(3px);
            box-shadow:
                0 1px 0 #0a1a0a,
                0 2px 5px rgba(0,0,0,0.5);
        }
        .modal-hidden {
            display: none;
        }

        /* Accessibility Panel */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #0a0a0a;
            border-radius: 4px;
            border: 1px solid #222;
            margin-bottom: 10px;
        }
        .toggle-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: linear-gradient(to bottom, #1a1a1a, #0a0a0a);
            border: 2px solid #333;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: linear-gradient(to bottom, #666, #444);
            border-radius: 50%;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .toggle-switch.active {
            background: linear-gradient(to bottom, #1a3a1a, #0a2a0a);
            border-color: #2a5a2a;
        }
        .toggle-switch.active::after {
            left: 22px;
            background: linear-gradient(to bottom, #6f6, #4c4);
            box-shadow: 0 0 8px #0f0, 0 2px 4px rgba(0,0,0,0.5);
        }
        .contrast-display {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 4px;
            padding: 8px;
        }
        .contrast-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .contrast-value {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            min-width: 50px;
            text-align: center;
        }
        .contrast-value.pass {
            color: #4f4;
            background: #0a1a0a;
            border: 1px solid #2a5a2a;
            text-shadow: 0 0 8px rgba(68,255,68,0.5);
        }
        .contrast-value.fail {
            color: #f44;
            background: #1a0a0a;
            border: 1px solid #5a2a2a;
            text-shadow: 0 0 8px rgba(255,68,68,0.5);
        }
        .contrast-value.warn {
            color: #fa0;
            background: #1a1a0a;
            border: 1px solid #5a5a2a;
            text-shadow: 0 0 8px rgba(255,170,0,0.5);
        }
        .a11y-status {
            text-align: center;
            margin-top: 8px;
            padding: 6px;
            border-radius: 4px;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .a11y-status.good {
            background: #0a1a0a;
            border: 1px solid #2a5a2a;
            color: #4f4;
        }
        .a11y-status.adjusted {
            background: #1a1a0a;
            border: 1px solid #5a5a2a;
            color: #fa0;
        }
    </style>
</head>
<body>
    <div id="stage-container">
        <canvas id="stage"></canvas>
    </div>

    <div id="control-panel">
        <div class="power-indicator">
            <div class="power-led"></div>
            <span>Power</span>
        </div>

        <div class="panel-section">
            <div class="panel-label">Center Spotlight - RGB Faders</div>
            <div class="slider-container">
                <div class="slider-row">
                    <span class="slider-label red">R</span>
                    <input type="range" id="red-slider" class="color-slider" min="0" max="255" value="255">
                    <span class="slider-value" id="red-value">255</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label green">G</span>
                    <input type="range" id="green-slider" class="color-slider" min="0" max="255" value="0">
                    <span class="slider-value" id="green-value">0</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label blue">B</span>
                    <input type="range" id="blue-slider" class="color-slider" min="0" max="255" value="0">
                    <span class="slider-value" id="blue-value">0</span>
                </div>
                <div class="color-preview-box" id="main-preview"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-label">Harmony Mode - Side Spotlights</div>
            <div class="harmony-buttons">
                <button class="harmony-btn active" data-harmony="complementary">Complementary</button>
                <button class="harmony-btn" data-harmony="analogous">Analogous</button>
                <button class="harmony-btn" data-harmony="triadic">Triadic</button>
                <button class="harmony-btn" data-harmony="split">Split-Complementary</button>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-label">Accessible Palette</div>
            <div class="toggle-container">
                <span class="toggle-label">Ensure Contrast</span>
                <div class="toggle-switch" id="a11y-toggle"></div>
            </div>
            <div class="contrast-display">
                <div class="contrast-row">
                    <span>Left vs Center</span>
                    <span class="contrast-value" id="contrast-lc">--</span>
                </div>
                <div class="contrast-row">
                    <span>Center vs Right</span>
                    <span class="contrast-value" id="contrast-cr">--</span>
                </div>
                <div class="contrast-row">
                    <span>Left vs Right</span>
                    <span class="contrast-value" id="contrast-lr">--</span>
                </div>
            </div>
            <div class="a11y-status good" id="a11y-status">Colors Distinguishable</div>
        </div>

        <div class="panel-section">
            <div class="panel-label">Output Monitor</div>
            <div class="color-preview">
                <div>
                    <div class="preview-swatch" id="left-swatch"></div>
                    <div class="swatch-label">Left</div>
                </div>
                <div>
                    <div class="preview-swatch" id="main-swatch"></div>
                    <div class="swatch-label">Center</div>
                </div>
                <div>
                    <div class="preview-swatch" id="right-swatch"></div>
                    <div class="swatch-label">Right</div>
                </div>
            </div>
            <div class="led-strip">
                <div class="led on"></div>
                <div class="led amber"></div>
                <div class="led on"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-label">Quick Access</div>
            <div class="deco-buttons">
                <button class="deco-btn red-btn">Blackout</button>
                <button class="deco-btn amber-btn">Strobe</button>
                <button class="deco-btn">Fade</button>
                <button class="deco-btn">Chase</button>
                <button class="deco-btn">Preset 1</button>
                <button class="deco-btn">Preset 2</button>
                <button class="deco-btn">Preset 3</button>
                <button class="deco-btn">Preset 4</button>
            </div>
            <div class="led-strip">
                <div class="led"></div>
                <div class="led"></div>
                <div class="led red"></div>
                <div class="led"></div>
            </div>
        </div>

        <div class="brand-label">LightMaster Pro</div>
    </div>

    <!-- Instruction Modal -->
    <div class="modal-overlay" id="instruction-modal">
        <div class="modal-content">
            <div class="modal-title">LightMaster Pro</div>
            <div class="modal-text">
                Adjust the color of the <strong>center spotlight</strong> using the RGB faders,
                then select a <strong>harmony mode</strong> for the side spotlights to see how
                colored stage lights combine and interact.
            </div>
            <button class="modal-ok-btn" id="modal-ok">OK</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        let selectedR = 255;
        let selectedG = 0;
        let selectedB = 0;
        let harmonyType = 'complementary';

        // ===== CANVAS SETUP =====
        const stage = document.getElementById('stage');
        const stageCtx = stage.getContext('2d');

        // RGB Sliders
        const redSlider = document.getElementById('red-slider');
        const greenSlider = document.getElementById('green-slider');
        const blueSlider = document.getElementById('blue-slider');
        const redValue = document.getElementById('red-value');
        const greenValue = document.getElementById('green-value');
        const blueValue = document.getElementById('blue-value');
        const mainPreview = document.getElementById('main-preview');

        function resizeStage() {
            const container = document.getElementById('stage-container');
            stage.width = container.clientWidth;
            stage.height = container.clientHeight;
            drawScene();
        }

        // ===== COLOR UTILITIES =====
        function hslToRgb(h, s, l) {
            s /= 100;
            l /= 100;
            const k = n => (n + h / 30) % 12;
            const a = s * Math.min(l, 1 - l);
            const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
            return [Math.round(f(0) * 255), Math.round(f(8) * 255), Math.round(f(4) * 255)];
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h * 360, s * 100, l * 100];
        }

        function rgbToString(rgb) {
            return `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        }

        // ===== ACCESSIBILITY - CONTRAST =====
        let accessibilityMode = false;
        const MIN_CONTRAST_RATIO = 3.0; // WCAG AA for large text/graphics

        function linearize(value) {
            value /= 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
        }

        function getRelativeLuminance(rgb) {
            const r = linearize(rgb[0]);
            const g = linearize(rgb[1]);
            const b = linearize(rgb[2]);
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        function getContrastRatio(rgb1, rgb2) {
            const l1 = getRelativeLuminance(rgb1);
            const l2 = getRelativeLuminance(rgb2);
            const lighter = Math.max(l1, l2);
            const darker = Math.min(l1, l2);
            return (lighter + 0.05) / (darker + 0.05);
        }

        function adjustColorForContrast(baseColor, targetColor, minRatio) {
            let adjusted = [...targetColor];
            const [h, s, l] = rgbToHsl(adjusted[0], adjusted[1], adjusted[2]);
            let currentRatio = getContrastRatio(baseColor, adjusted);

            if (currentRatio >= minRatio) return adjusted;

            // Try adjusting lightness to achieve contrast
            const baseLum = getRelativeLuminance(baseColor);
            const targetLum = getRelativeLuminance(adjusted);

            // Determine direction: make lighter or darker
            let newL = l;
            const step = 5;
            const maxIterations = 20;

            if (baseLum > targetLum) {
                // Base is lighter, make target darker
                for (let i = 0; i < maxIterations && currentRatio < minRatio; i++) {
                    newL = Math.max(10, newL - step);
                    adjusted = hslToRgb(h, s, newL);
                    currentRatio = getContrastRatio(baseColor, adjusted);
                }
            } else {
                // Base is darker, make target lighter
                for (let i = 0; i < maxIterations && currentRatio < minRatio; i++) {
                    newL = Math.min(90, newL + step);
                    adjusted = hslToRgb(h, s, newL);
                    currentRatio = getContrastRatio(baseColor, adjusted);
                }
            }

            // If still not enough, also adjust saturation
            if (currentRatio < minRatio) {
                let newS = s;
                for (let i = 0; i < maxIterations && currentRatio < minRatio; i++) {
                    newS = Math.max(20, newS - step);
                    adjusted = hslToRgb(h, newS, newL);
                    currentRatio = getContrastRatio(baseColor, adjusted);
                }
            }

            return adjusted;
        }

        function updateContrastDisplay(mainColor, leftColor, rightColor) {
            const contrastLC = getContrastRatio(leftColor, mainColor);
            const contrastCR = getContrastRatio(mainColor, rightColor);
            const contrastLR = getContrastRatio(leftColor, rightColor);

            const lcEl = document.getElementById('contrast-lc');
            const crEl = document.getElementById('contrast-cr');
            const lrEl = document.getElementById('contrast-lr');
            const statusEl = document.getElementById('a11y-status');

            function setContrastClass(el, ratio) {
                el.textContent = ratio.toFixed(1) + ':1';
                el.classList.remove('pass', 'fail', 'warn');
                if (ratio >= MIN_CONTRAST_RATIO) {
                    el.classList.add('pass');
                } else if (ratio >= 2.0) {
                    el.classList.add('warn');
                } else {
                    el.classList.add('fail');
                }
            }

            setContrastClass(lcEl, contrastLC);
            setContrastClass(crEl, contrastCR);
            setContrastClass(lrEl, contrastLR);

            const allPass = contrastLC >= MIN_CONTRAST_RATIO && contrastCR >= MIN_CONTRAST_RATIO && contrastLR >= MIN_CONTRAST_RATIO;
            statusEl.classList.remove('good', 'adjusted');

            if (allPass) {
                statusEl.textContent = 'Colors Distinguishable';
                statusEl.classList.add('good');
            } else if (accessibilityMode) {
                statusEl.textContent = 'Colors Adjusted';
                statusEl.classList.add('adjusted');
            } else {
                statusEl.textContent = 'Low Contrast';
                statusEl.classList.add('adjusted');
            }
        }

        function getHarmonyColorsFromRgb(r, g, b, type) {
            const [h, s, l] = rgbToHsl(r, g, b);
            const colors = { left: [], right: [] };

            switch(type) {
                case 'complementary':
                    colors.left = [hslToRgb((h + 180) % 360, s, l)];
                    colors.right = [hslToRgb((h + 180) % 360, s, l)];
                    break;
                case 'analogous':
                    colors.left = [hslToRgb((h + 330) % 360, s, l)];
                    colors.right = [hslToRgb((h + 30) % 360, s, l)];
                    break;
                case 'triadic':
                    colors.left = [hslToRgb((h + 120) % 360, s, l)];
                    colors.right = [hslToRgb((h + 240) % 360, s, l)];
                    break;
                case 'split':
                    colors.left = [hslToRgb((h + 150) % 360, s, l)];
                    colors.right = [hslToRgb((h + 210) % 360, s, l)];
                    break;
            }
            return colors;
        }

        function updateSliderDisplay() {
            redValue.textContent = selectedR;
            greenValue.textContent = selectedG;
            blueValue.textContent = selectedB;
            mainPreview.style.backgroundColor = `rgb(${selectedR}, ${selectedG}, ${selectedB})`;
        }

        // ===== STAGE ELEMENTS =====
        function drawCeiling(ctx, w, h, ceilingY) {
            // Ceiling base
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, w, ceilingY);

            // Ceiling panels/beams
            ctx.fillStyle = '#252525';
            const beamWidth = w / 8;
            for (let i = 0; i < 8; i++) {
                ctx.fillRect(i * beamWidth, 0, beamWidth - 2, ceilingY);
            }

            // Lighting rig bar
            ctx.fillStyle = '#333';
            ctx.fillRect(0, ceilingY - 8, w, 8);
            ctx.fillStyle = '#444';
            ctx.fillRect(0, ceilingY - 6, w, 2);
        }

        function drawCurtains(ctx, w, h, ceilingY, floorY) {
            const curtainWidth = w * 0.12;
            const folds = 8;
            const foldWidth = curtainWidth / folds;

            // Left curtain
            for (let i = 0; i < folds; i++) {
                const x = i * foldWidth;
                const shade = i % 2 === 0 ? '#4a1a1a' : '#3a0a0a';
                ctx.fillStyle = shade;
                ctx.beginPath();
                ctx.moveTo(x, ceilingY);
                ctx.lineTo(x + foldWidth, ceilingY);
                ctx.lineTo(x + foldWidth, floorY);
                ctx.lineTo(x, floorY);
                ctx.closePath();
                ctx.fill();
            }

            // Right curtain
            for (let i = 0; i < folds; i++) {
                const x = w - curtainWidth + i * foldWidth;
                const shade = i % 2 === 0 ? '#4a1a1a' : '#3a0a0a';
                ctx.fillStyle = shade;
                ctx.beginPath();
                ctx.moveTo(x, ceilingY);
                ctx.lineTo(x + foldWidth, ceilingY);
                ctx.lineTo(x + foldWidth, floorY);
                ctx.lineTo(x, floorY);
                ctx.closePath();
                ctx.fill();
            }

            // Curtain valance (top drape)
            ctx.fillStyle = '#5a2020';
            ctx.beginPath();
            ctx.moveTo(0, ceilingY);
            ctx.lineTo(w, ceilingY);
            ctx.lineTo(w, ceilingY + 25);
            for (let x = w; x >= 0; x -= 40) {
                ctx.quadraticCurveTo(x - 20, ceilingY + 40, x - 40, ceilingY + 25);
            }
            ctx.closePath();
            ctx.fill();

            // Gold trim
            ctx.strokeStyle = '#8B7500';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, ceilingY + 25);
            for (let x = 0; x <= w; x += 40) {
                ctx.quadraticCurveTo(x + 20, ceilingY + 40, x + 40, ceilingY + 25);
            }
            ctx.stroke();
        }

        function drawHardwoodFloor(ctx, w, h, floorY) {
            const plankHeight = 20;
            const plankWidth = 80;

            // Floor base with perspective gradient
            const floorGradient = ctx.createLinearGradient(0, floorY, 0, h);
            floorGradient.addColorStop(0, '#3d2817');
            floorGradient.addColorStop(1, '#2a1a0f');
            ctx.fillStyle = floorGradient;
            ctx.fillRect(0, floorY, w, h - floorY);

            // Draw planks
            let row = 0;
            for (let y = floorY; y < h; y += plankHeight) {
                const offset = (row % 2) * (plankWidth / 2);
                for (let x = -plankWidth + offset; x < w; x += plankWidth) {
                    // Plank variation
                    const brightness = 0.9 + Math.random() * 0.2;
                    const r = Math.floor(61 * brightness);
                    const g = Math.floor(40 * brightness);
                    const b = Math.floor(23 * brightness);
                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(x, y, plankWidth - 2, plankHeight - 1);

                    // Wood grain
                    ctx.strokeStyle = `rgba(0, 0, 0, 0.1)`;
                    ctx.lineWidth = 1;
                    for (let g = 0; g < 3; g++) {
                        ctx.beginPath();
                        ctx.moveTo(x, y + 5 + g * 5);
                        ctx.lineTo(x + plankWidth - 2, y + 5 + g * 5);
                        ctx.stroke();
                    }
                }
                row++;
            }
        }

        function drawBackdrop(ctx, w, h, ceilingY, floorY) {
            const curtainWidth = w * 0.12;
            const backdropX = curtainWidth;
            const backdropW = w - curtainWidth * 2;

            // Night sky backdrop
            const skyGradient = ctx.createLinearGradient(0, ceilingY, 0, floorY);
            skyGradient.addColorStop(0, '#0a0a2a');
            skyGradient.addColorStop(0.5, '#1a1a4a');
            skyGradient.addColorStop(1, '#0f0f3a');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(backdropX, ceilingY + 30, backdropW, floorY - ceilingY - 30);

            // Stars on backdrop
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 40; i++) {
                const sx = backdropX + (i * 137.5) % backdropW;
                const sy = ceilingY + 50 + (i * 89.3) % ((floorY - ceilingY) * 0.4);
                const size = (i % 3) + 1;
                ctx.beginPath();
                ctx.arc(sx, sy, size * 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Moon
            ctx.fillStyle = 'rgba(255, 255, 220, 0.9)';
            ctx.beginPath();
            ctx.arc(w * 0.7, ceilingY + 80, 25, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawTreeProps(ctx, w, h, floorY, colors) {
            const curtainWidth = w * 0.12;
            // Three trees - one directly under each spotlight
            const treePositions = [
                { x: curtainWidth + w * 0.12, scale: 1.0, color: colors.left },
                { x: w * 0.5, scale: 1.15, color: colors.main },
                { x: w - curtainWidth - w * 0.12, scale: 1.0, color: colors.right },
            ];

            treePositions.forEach((tree) => {
                const treeH = h * 0.4 * tree.scale;
                const treeW = treeH * 0.35;
                const x = tree.x;
                const y = floorY;
                const lightColor = tree.color;

                // Tree base color (dark green)
                const baseR = 20, baseG = 40, baseB = 25;

                // Trunk with lighting
                const trunkLight = 0.3;
                ctx.fillStyle = `rgb(${40 + lightColor[0] * trunkLight * 0.3}, ${30 + lightColor[1] * trunkLight * 0.1}, ${20 + lightColor[2] * trunkLight * 0.1})`;
                ctx.fillRect(x - treeW * 0.08, y - treeH * 0.25, treeW * 0.16, treeH * 0.25);

                // Foliage layers with front lighting
                for (let i = 0; i < 4; i++) {
                    const layerY = y - treeH * 0.2 - i * treeH * 0.2;
                    const layerW = treeW * (1 - i * 0.15);

                    // Lit side (front)
                    const lightIntensity = 0.5 - i * 0.05;
                    const r = Math.min(255, baseR + lightColor[0] * lightIntensity);
                    const g = Math.min(255, baseG + lightColor[1] * lightIntensity);
                    const b = Math.min(255, baseB + lightColor[2] * lightIntensity);

                    ctx.fillStyle = `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
                    ctx.beginPath();
                    ctx.moveTo(x - layerW, layerY);
                    ctx.lineTo(x, layerY - treeH * 0.25);
                    ctx.lineTo(x + layerW, layerY);
                    ctx.closePath();
                    ctx.fill();

                    // Highlight edge
                    ctx.strokeStyle = `rgba(${lightColor[0]}, ${lightColor[1]}, ${lightColor[2]}, 0.4)`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
        }

        // ===== SPOTLIGHT RENDERING =====
        function drawSpotlight(ctx, x, y, targetX, targetY, color, intensity = 1) {
            const rgb = color;
            const spreadAngle = 0.3;
            const length = Math.sqrt((targetX - x) ** 2 + (targetY - y) ** 2);
            const angle = Math.atan2(targetY - y, targetX - x);

            // Light beam
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';

            const gradient = ctx.createRadialGradient(
                targetX, targetY, 0,
                targetX, targetY, length * 0.6
            );
            gradient.addColorStop(0, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${0.6 * intensity})`);
            gradient.addColorStop(0.3, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${0.3 * intensity})`);
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(
                targetX + Math.cos(angle + spreadAngle) * length * 0.5,
                targetY + Math.sin(angle + spreadAngle) * length * 0.3
            );
            ctx.lineTo(
                targetX + Math.cos(angle - spreadAngle) * length * 0.5,
                targetY + Math.sin(angle - spreadAngle) * length * 0.3
            );
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            // Ground pool of light
            const poolGradient = ctx.createRadialGradient(
                targetX, targetY, 0,
                targetX, targetY, length * 0.4
            );
            poolGradient.addColorStop(0, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${0.5 * intensity})`);
            poolGradient.addColorStop(0.5, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${0.2 * intensity})`);
            poolGradient.addColorStop(1, 'rgba(0,0,0,0)');

            ctx.beginPath();
            ctx.ellipse(targetX, targetY + 20, length * 0.35, length * 0.15, 0, 0, Math.PI * 2);
            ctx.fillStyle = poolGradient;
            ctx.fill();

            ctx.restore();
        }

        function drawSpotlightFixture(ctx, x, y, color) {
            // Housing
            ctx.fillStyle = '#222';
            ctx.beginPath();
            ctx.ellipse(x, y, 15, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Lens glow
            ctx.fillStyle = `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.8)`;
            ctx.beginPath();
            ctx.arc(x, y + 5, 8, 0, Math.PI * 2);
            ctx.fill();

            // Lens highlight
            ctx.fillStyle = `rgba(255, 255, 255, 0.3)`;
            ctx.beginPath();
            ctx.arc(x - 2, y + 3, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        // ===== MAIN SCENE =====
        function drawScene() {
            const w = stage.width;
            const h = stage.height;
            const ceilingY = h * 0.12;
            const floorY = h * 0.78;

            // Clear canvas
            stageCtx.fillStyle = '#000';
            stageCtx.fillRect(0, 0, w, h);

            // Get current colors from RGB sliders
            const mainColor = [selectedR, selectedG, selectedB];
            const harmony = getHarmonyColorsFromRgb(selectedR, selectedG, selectedB, harmonyType);
            let leftColor = harmony.left[0];
            let rightColor = harmony.right[0];

            // Apply accessibility adjustments if enabled
            if (accessibilityMode) {
                leftColor = adjustColorForContrast(mainColor, leftColor, MIN_CONTRAST_RATIO);
                rightColor = adjustColorForContrast(mainColor, rightColor, MIN_CONTRAST_RATIO);
                // Also ensure left and right have contrast
                rightColor = adjustColorForContrast(leftColor, rightColor, MIN_CONTRAST_RATIO);
            }

            // Update contrast display
            updateContrastDisplay(mainColor, leftColor, rightColor);

            // Draw backdrop (behind everything)
            drawBackdrop(stageCtx, w, h, ceilingY, floorY);

            // Draw spotlight beams onto stage (front lighting effect)
            // Spotlights shine from ceiling onto the floor/trees
            const curtainWidth = w * 0.12;
            drawSpotlight(stageCtx, w * 0.25, ceilingY + 10, curtainWidth + w * 0.12, floorY - 30, leftColor, 0.9);
            drawSpotlight(stageCtx, w * 0.5, ceilingY + 5, w * 0.5, floorY - 20, mainColor, 1.2);
            drawSpotlight(stageCtx, w * 0.75, ceilingY + 10, w - curtainWidth - w * 0.12, floorY - 30, rightColor, 0.9);

            // Draw tree props (illuminated by front lights)
            drawTreeProps(stageCtx, w, h, floorY, { main: mainColor, left: leftColor, right: rightColor });

            // Draw hardwood floor
            drawHardwoodFloor(stageCtx, w, h, floorY);

            // Draw floor light pools
            stageCtx.save();
            stageCtx.globalCompositeOperation = 'lighter';

            // Left pool
            const leftPoolGrad = stageCtx.createRadialGradient(curtainWidth + w * 0.12, floorY + 10, 0, curtainWidth + w * 0.12, floorY + 10, w * 0.15);
            leftPoolGrad.addColorStop(0, `rgba(${leftColor[0]}, ${leftColor[1]}, ${leftColor[2]}, 0.3)`);
            leftPoolGrad.addColorStop(1, 'rgba(0,0,0,0)');
            stageCtx.fillStyle = leftPoolGrad;
            stageCtx.fillRect(0, floorY, w, h - floorY);

            // Center pool
            const centerPoolGrad = stageCtx.createRadialGradient(w * 0.5, floorY + 10, 0, w * 0.5, floorY + 10, w * 0.18);
            centerPoolGrad.addColorStop(0, `rgba(${mainColor[0]}, ${mainColor[1]}, ${mainColor[2]}, 0.35)`);
            centerPoolGrad.addColorStop(1, 'rgba(0,0,0,0)');
            stageCtx.fillStyle = centerPoolGrad;
            stageCtx.fillRect(0, floorY, w, h - floorY);

            // Right pool
            const rightPoolGrad = stageCtx.createRadialGradient(w - curtainWidth - w * 0.12, floorY + 10, 0, w - curtainWidth - w * 0.12, floorY + 10, w * 0.15);
            rightPoolGrad.addColorStop(0, `rgba(${rightColor[0]}, ${rightColor[1]}, ${rightColor[2]}, 0.3)`);
            rightPoolGrad.addColorStop(1, 'rgba(0,0,0,0)');
            stageCtx.fillStyle = rightPoolGrad;
            stageCtx.fillRect(0, floorY, w, h - floorY);

            stageCtx.restore();

            // Draw curtains (in front of backdrop, beside stage)
            drawCurtains(stageCtx, w, h, ceilingY, floorY);

            // Draw ceiling with lighting rig
            drawCeiling(stageCtx, w, h, ceilingY);

            // Spotlight fixtures on ceiling
            drawSpotlightFixture(stageCtx, w * 0.25, ceilingY - 15, leftColor);
            drawSpotlightFixture(stageCtx, w * 0.5, ceilingY - 18, mainColor);
            drawSpotlightFixture(stageCtx, w * 0.75, ceilingY - 15, rightColor);

            // Update swatches
            document.getElementById('main-swatch').style.backgroundColor = rgbToString(mainColor);
            document.getElementById('left-swatch').style.backgroundColor = rgbToString(leftColor);
            document.getElementById('right-swatch').style.backgroundColor = rgbToString(rightColor);
        }

        // ===== EVENT HANDLERS =====
        function handleSliderChange() {
            selectedR = parseInt(redSlider.value);
            selectedG = parseInt(greenSlider.value);
            selectedB = parseInt(blueSlider.value);
            updateSliderDisplay();
            drawScene();
        }

        redSlider.addEventListener('input', handleSliderChange);
        greenSlider.addEventListener('input', handleSliderChange);
        blueSlider.addEventListener('input', handleSliderChange);

        // Harmony buttons
        document.querySelectorAll('.harmony-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.harmony-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                harmonyType = btn.dataset.harmony;
                drawScene();
            });
        });

        // Accessibility toggle
        const a11yToggle = document.getElementById('a11y-toggle');
        a11yToggle.addEventListener('click', () => {
            accessibilityMode = !accessibilityMode;
            a11yToggle.classList.toggle('active', accessibilityMode);
            drawScene();
        });

        // ===== MODAL =====
        const modal = document.getElementById('instruction-modal');
        const modalOkBtn = document.getElementById('modal-ok');

        modalOkBtn.addEventListener('click', () => {
            modal.classList.add('modal-hidden');
        });

        // ===== INITIALIZATION =====
        window.addEventListener('resize', resizeStage);
        resizeStage();
        updateSliderDisplay();
        drawScene();
    </script>
</body>
</html>
